<!DOCTYPE html>
<html lang="en">
    <head>
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta http-equiv="content-type" content="text/html; charset=utf-8">
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">

        
            
        

      <title></title>

      
      <script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>
      <script src="https://sdk.jinrishici.com/v2/browser/jinrishici.js" charset="utf-8"></script>
      

      <!-- CSS -->
      
      <link rel="stylesheet" href="https://king-key.github.io/book.css">
      <link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css">
      <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
        

      <script>
          document.addEventListener('DOMContentLoaded', function () {
            var menu = document.getElementById('navMenu');
            var toggleButton = document.getElementById('toggleMenu');

            toggleButton.addEventListener('click', function () {
                menu.classList.toggle('active');
            });
        });

      </script>


      
      
    </head>

    <body>
        <div class="menu">
            <div class="card">
                <div class="card-border-top"></div>
                <div class="img"></div>
                <span> Wang Guo</span>
                <p class="job"> <a class="link" href="https://qingkelab.github.io">é’ç¨ç¤¾åŒº</a>åˆ›å§‹äºº </p>
                <center><img src="https://img.shields.io/badge/MBTIæ€§æ ¼ç±»å‹-INTJ(ç‹¬ç«‹è‡ªä¸»çš„ä¸“å®¶)-blue" width="70%"></img></center><br>
              
                <div class="radio-inputs">
                        <label>
                            <a class="link"  href="/ä¸»é¡µ/">
                            <i class="bi bi-person-rolodex"></i>
                            </a>
                        </label>

                        <label>
                            <a cla  ss="link" href="https://github.com/King-Key">
                            <i class="bi-github"></i>
                            </a>
                        </label>

                        <label>
                            <a class="link"  href="https://blog.csdn.net/King_key?type=blog">
                            <i class="bi bi-body-text"></i>
                            </a>
                        </label>

                        <label>
                            <a class="link"  href="https://twitter.com/KingKey113">
                            <i class="bi bi-twitter"></i>
                            </a>
                        </label>

                </div><br>
            


              <nav role="navigation">
                <ul>
                    
                        
                        
                            
                            <li >
                                
                                <a href="https://king-key.github.io/ä¸»é¡µ/">
                                    
                                    <!--  -->
                                    <i class="bi bi-bookmarks"></i>
                                    About

                                </a>
                                
                            <!-- </li><hr align=center color=#8b8b8b8 size=4> -->
                        
                            
                            <li >
                                
                                <a href="https://king-key.github.io/Blog/">
                                    
                                    <!--  -->
                                    <i class="bi bi-bookmarks"></i>
                                    Blog

                                </a>
                                
                            <!-- </li><hr align=center color=#8b8b8b8 size=4> -->
                        
                            
                            <li >
                                
                                <a href="https://king-key.github.io/éšç¬”/">
                                    
                                    <!--  -->
                                    <i class="bi bi-bookmarks"></i>
                                    éšç¬”

                                </a>
                                
                            <!-- </li><hr align=center color=#8b8b8b8 size=4> -->
                        
                            
                            <li >
                                
                                <a href="https://king-key.github.io/å‹æƒ…é“¾æ¥/">
                                    
                                    <!--  -->
                                    <i class="bi bi-bookmarks"></i>
                                    links

                                </a>
                                
                            <!-- </li><hr align=center color=#8b8b8b8 size=4> -->
                        
                    
                </ul>
            </nav>

            </div>
            
            
        </div>

        <div class="page">
            <div class="page__header">
                <div class="menu-icon">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
                
                <span class="search-icon">ğŸ”</span>
                
            </div>

            <div class="page__content">
                
                <div class="search-container">
                    <input id="search" type="search" placeholder="Search..">
                    <div class="search-results">
                        <div class="search-results__header"></div>
                        <ul class="search-results__items"></ul>
                    </div>
                </div>
                
                <div class="book-content">
                    
    <h1>ğŸ–‹ ChatGLM2-6B-Int4æœ¬åœ°éƒ¨ç½² </h1>
    â— â°ï¸<i> Push timeï¼š2023-06-29 11:06:27</i>
    <hr align=center color=#987cb9 size=4>
    
    <!-- å¼•å…¥ç›®å½• -->
    <div class="sidebar" id="sidebar">
        <ul id="toc"></ul>
    </div>


    <div class="content">
        <blockquote>
<p>ChatGLM2-6B æ˜¯å¼€æºä¸­è‹±åŒè¯­å¯¹è¯æ¨¡å‹ ChatGLM-6B çš„ç¬¬äºŒä»£ç‰ˆæœ¬
GitHubåœ°å€ï¼šhttps://github.com/THUDM/ChatGLM2-6B</p>
</blockquote>
<h4 id="1-xian-kan-xiao-guo">1ã€å…ˆçœ‹æ•ˆæœ</h4>
<p><img src="https://king-key.github.io/Blog/2023/Q2/chatglm2-6b-int4ben-di-bu-shu/./chatglm.gif" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" /></p>
<h4 id="2-chatglm2-6bxin-te-xing">2ã€ChatGLM2-6Bæ–°ç‰¹æ€§</h4>
<ul>
<li>
<p>æ›´å¼ºå¤§çš„æ€§èƒ½ï¼šåŸºäº ChatGLM åˆä»£æ¨¡å‹çš„å¼€å‘ç»éªŒï¼Œæˆ‘ä»¬å…¨é¢å‡çº§äº† ChatGLM2-6B çš„åŸºåº§æ¨¡å‹ã€‚ChatGLM2-6B ä½¿ç”¨äº† GLM çš„æ··åˆç›®æ ‡å‡½æ•°ï¼Œç»è¿‡äº† 1.4T ä¸­è‹±æ ‡è¯†ç¬¦çš„é¢„è®­ç»ƒä¸äººç±»åå¥½å¯¹é½è®­ç»ƒï¼Œè¯„æµ‹ç»“æœæ˜¾ç¤ºï¼Œç›¸æ¯”äºåˆä»£æ¨¡å‹ï¼ŒChatGLM2-6B åœ¨ MMLUï¼ˆ+23%ï¼‰ã€CEvalï¼ˆ+33%ï¼‰ã€GSM8Kï¼ˆ+571%ï¼‰ ã€BBHï¼ˆ+60%ï¼‰ç­‰æ•°æ®é›†ä¸Šçš„æ€§èƒ½å–å¾—äº†å¤§å¹…åº¦çš„æå‡ï¼Œåœ¨åŒå°ºå¯¸å¼€æºæ¨¡å‹ä¸­å…·æœ‰è¾ƒå¼ºçš„ç«äº‰åŠ›ã€‚</p>
</li>
<li>
<p>æ›´é•¿çš„ä¸Šä¸‹æ–‡ï¼šåŸºäº FlashAttention æŠ€æœ¯ï¼Œæˆ‘ä»¬å°†åŸºåº§æ¨¡å‹çš„ä¸Šä¸‹æ–‡é•¿åº¦ï¼ˆContext Lengthï¼‰ç”± ChatGLM-6B çš„ 2K æ‰©å±•åˆ°äº† 32Kï¼Œå¹¶åœ¨å¯¹è¯é˜¶æ®µä½¿ç”¨ 8K çš„ä¸Šä¸‹æ–‡é•¿åº¦è®­ç»ƒï¼Œå…è®¸æ›´å¤šè½®æ¬¡çš„å¯¹è¯ã€‚ä½†å½“å‰ç‰ˆæœ¬çš„ ChatGLM2-6B å¯¹å•è½®è¶…é•¿æ–‡æ¡£çš„ç†è§£èƒ½åŠ›æœ‰é™ï¼Œæˆ‘ä»¬ä¼šåœ¨åç»­è¿­ä»£å‡çº§ä¸­ç€é‡è¿›è¡Œä¼˜åŒ–ã€‚</p>
</li>
<li>
<p>æ›´é«˜æ•ˆçš„æ¨ç†ï¼šåŸºäº Multi-Query Attention æŠ€æœ¯ï¼ŒChatGLM2-6B æœ‰æ›´é«˜æ•ˆçš„æ¨ç†é€Ÿåº¦å’Œæ›´ä½çš„æ˜¾å­˜å ç”¨ï¼šåœ¨å®˜æ–¹çš„æ¨¡å‹å®ç°ä¸‹ï¼Œæ¨ç†é€Ÿåº¦ç›¸æ¯”åˆä»£æå‡äº† 42%ï¼ŒINT4 é‡åŒ–ä¸‹ï¼Œ6G æ˜¾å­˜æ”¯æŒçš„å¯¹è¯é•¿åº¦ç”± 1K æå‡åˆ°äº† 8Kã€‚</p>
</li>
<li>
<p>æ›´å¼€æ”¾çš„åè®®ï¼šChatGLM2-6B æƒé‡å¯¹å­¦æœ¯ç ”ç©¶å®Œå…¨å¼€æ”¾ï¼Œåœ¨è·å¾—å®˜æ–¹çš„ä¹¦é¢è®¸å¯åï¼Œäº¦å…è®¸å•†ä¸šä½¿ç”¨ã€‚å¦‚æœæ‚¨å‘ç°æˆ‘ä»¬çš„å¼€æºæ¨¡å‹å¯¹æ‚¨çš„ä¸šåŠ¡æœ‰ç”¨ï¼Œæˆ‘ä»¬æ¬¢è¿æ‚¨å¯¹ä¸‹ä¸€ä»£æ¨¡å‹ ChatGLM3 ç ”å‘çš„æèµ ã€‚</p>
</li>
</ul>
<h4 id="3-ben-di-bu-shu-chatglm2-6b-int4">3ã€æœ¬åœ°éƒ¨ç½²(ChatGLM2-6B-int4)</h4>
<h5 id="bu-shu-huan-jing">éƒ¨ç½²ç¯å¢ƒ</h5>
<pre style="background-color:#eff1f5;color:#4f5b66;"><code><span>wsl2-ubuntu22.04 LTS
</span><span>
</span><span>+-----------------------------------------------------------------------------+
</span><span>| NVIDIA-SMI 525.104      Driver Version: 528.79       CUDA Version: 12.0     |
</span><span>|-------------------------------+----------------------+----------------------+
</span><span>| GPU  Name        Persistence-M| Bus-Id        Disp.A | Volatile Uncorr. ECC |
</span><span>| Fan  Temp  Perf  Pwr:Usage/Cap|         Memory-Usage | GPU-Util  Compute M. |
</span><span>|                               |                      |               MIG M. |
</span><span>|===============================+======================+======================|
</span><span>|   0  NVIDIA GeForce ...  On   | 00000000:01:00.0  On |                  N/A |
</span><span>| N/A   45C    P8     5W /  80W |    928MiB /  6144MiB |      3%      Default |
</span><span>|                               |                      |                  N/A |
</span><span>+-------------------------------+----------------------+----------------------+
</span><span>
</span><span>+-----------------------------------------------------------------------------+
</span><span>| Processes:                                                                  |
</span><span>|  GPU   GI   CI        PID   Type   Process name                  GPU Memory |
</span><span>|        ID   ID                                                   Usage      |
</span><span>|=============================================================================|
</span><span>|    0   N/A  N/A        23      G   /Xwayland                       N/A      |
</span><span>+-----------------------------------------------------------------------------+
</span></code></pre>
<h5 id="xia-zai">ä¸‹è½½</h5>
<pre data-lang="shell" style="background-color:#eff1f5;color:#4f5b66;" class="language-shell "><code class="language-shell" data-lang="shell"><span>git clone https://github.com/THUDM/ChatGLM2-6B
</span><span>cd ChatGLM2-6B
</span></code></pre>
<h5 id="chuang-jian-xu-ni-huan-jing-an-zhuang-ku">åˆ›å»ºè™šæ‹Ÿç¯å¢ƒï¼Œå®‰è£…åº“</h5>
<pre data-lang="shell" style="background-color:#eff1f5;color:#4f5b66;" class="language-shell "><code class="language-shell" data-lang="shell"><span>virtualenv venv
</span><span>source venv/bin/activate
</span><span>
</span><span>pip install -r requirements.txt
</span></code></pre>
<h5 id="ben-di-mo-xing-xia-zai">æœ¬åœ°æ¨¡å‹ä¸‹è½½</h5>
<pre data-lang="shell" style="background-color:#eff1f5;color:#4f5b66;" class="language-shell "><code class="language-shell" data-lang="shell"><span>git clone https://huggingface.co/THUDM/chatglm2-6b-int4
</span></code></pre>
<p>ç„¶ååœ¨<a href="https://cloud.tsinghua.edu.cn/d/674208019e314311ab5c/?p=%2F&amp;mode=list">æ¸…åå¤§å­¦äº‘ç›˜</a>ä¸‹è½½ç›¸åº”çš„æ¨¡å‹å‚æ•°æ–‡ä»¶,å¹¶å°†æ–‡ä»¶æ‹·è´åˆ°chatglm2-6b-int4æ–‡ä»¶å¤¹ä¸‹</p>
<p><img src="https://king-key.github.io/Blog/2023/Q2/chatglm2-6b-int4ben-di-bu-shu/./1.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" /></p>
<h5 id="int-4tui-li">int-4æ¨ç†</h5>
<p>éœ€è¦å…ˆä¿®æ”¹web_demo.py,ä¿®æ”¹å†…å®¹</p>
<pre data-lang="python" style="background-color:#eff1f5;color:#4f5b66;" class="language-python "><code class="language-python" data-lang="python"><span>//ç¬¬7è¡Œ,ä¿®æ”¹ä¸ºæœ¬åœ°æ¨¡å‹å‚æ•°åœ°å€
</span><span>
</span><span style="color:#a7adba;"># model = AutoModel.from_pretrained(&quot;THUDM/chatglm2-6b-int4&quot;, trust_remote_code=True).cuda()
</span><span>
</span><span>model = AutoModel.</span><span style="color:#bf616a;">from_pretrained</span><span>(&quot;</span><span style="color:#a3be8c;">./chatglm2-6b-int4</span><span>&quot;, </span><span style="color:#bf616a;">trust_remote_code</span><span>=</span><span style="color:#d08770;">True</span><span>).</span><span style="color:#bf616a;">cuda</span><span>()
</span><span>
</span></code></pre>
<h5 id="web-demo-py"><code>web_demo.py</code></h5>
<p>æ‰§è¡Œ</p>
<pre data-lang="sheLL" style="background-color:#eff1f5;color:#4f5b66;" class="language-sheLL "><code class="language-sheLL" data-lang="sheLL"><span>python web_demo.py
</span></code></pre>
<p><img src="https://king-key.github.io/Blog/2023/Q2/chatglm2-6b-int4ben-di-bu-shu/./2.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" /></p>
<p><img src="https://king-key.github.io/Blog/2023/Q2/chatglm2-6b-int4ben-di-bu-shu/./3.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" /></p>
<h5 id="yu-dao-de-wen-ti">é‡åˆ°çš„é—®é¢˜</h5>
<blockquote>
<p>é—®é¢˜1</p>
</blockquote>
<pre data-lang="shell" style="background-color:#eff1f5;color:#4f5b66;" class="language-shell "><code class="language-shell" data-lang="shell"><span>OSError: model/chatglm2-6b is not a local folder and is not a valid model identifier listed on &#39;https://huggingface.co/models&#39;
</span><span>If this is a private repository, make sure to pass a token having permission to this repo with `use_auth_token` or log in with `huggingface-cli login` and pass `use_auth_token=True`.
</span></code></pre>
<p>-- è§£å†³ï¼Œè¾“å…¥</p>
<pre style="background-color:#eff1f5;color:#4f5b66;"><code><span>huggingface-cli login 
</span></code></pre>
<p><img src="https://king-key.github.io/Blog/2023/Q2/chatglm2-6b-int4ben-di-bu-shu/./4.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" /></p>
<p>å¹¶ç‚¹å‡»é“¾æ¥ç”Ÿæˆ<strong>new token</strong>,æ‹·è´åˆ°shellä¸­è¾“å…¥å³å¯
<img src="https://king-key.github.io/Blog/2023/Q2/chatglm2-6b-int4ben-di-bu-shu/./5.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" /></p>
<p><img src="https://king-key.github.io/Blog/2023/Q2/chatglm2-6b-int4ben-di-bu-shu/./6.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" /></p>
<blockquote>
<p>é—®é¢˜2</p>
</blockquote>
<pre data-lang="shell" style="background-color:#eff1f5;color:#4f5b66;" class="language-shell "><code class="language-shell" data-lang="shell"><span>RuntimeError: Internal: src/sentencepiece_processor.cc(1101) [model_proto-&gt;ParseFromArray(serialized.data(), serialized.size())]
</span></code></pre>
<p>-- è§£å†³ï¼Œè¾“å…¥</p>
<pre data-lang="shell" style="background-color:#eff1f5;color:#4f5b66;" class="language-shell "><code class="language-shell" data-lang="shell"><span>sudo apt install libcudart11.0 libcublaslt11
</span></code></pre>

    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        $(document).ready(function() {
            // æ¸…ç©ºä¾§è¾¹æ ç›®å½•åˆ—è¡¨
            var headings = $('#toc').empty();
            var count = 0;
            $(document.body).find("h1, h2, h3, h4, h5, h6").each(function() {
                var title = $(this).text();
                var id = $(this).attr('id');
                var listItem = '<li><a href="#' + id + '">' + title + '</a></li>';
                
                if (count >= 1) {
                    headings.append(listItem);
                }
                count++; // å¢åŠ è®¡æ•°å™¨
            });

            // å¦‚æœç›®å½•åˆ—è¡¨ä¸ºç©ºï¼Œåˆ™ä¸æ˜¾ç¤ºä¾§è¾¹æ 
            if (headings.is(':empty')) {
                $('#sidebar').hide(); // éšè—ä¾§è¾¹æ 
            } else {
                // å¦‚æœç›®å½•ä¸ä¸ºç©ºï¼Œæ·»åŠ ç›®å½•æ ‡é¢˜å¹¶æ˜¾ç¤ºä¾§è¾¹æ 
                headings.prepend('<h2>æ–‡ç« ç›®å½•</h2>');
                $('#sidebar').show(); // æ˜¾ç¤ºä¾§è¾¹æ 
            }
        });
    </script>

    

                </div>
            </div>

            <div id="gitalk-container"></div>
            <script>    
            const gitalk = new Gitalk({
              clientID: 'f73599b3b06fe641455a', //'GitHub Application Client ID',
              clientSecret: '99686ea14b4603409e0c159cfd4fad2afd87a1a5', //'GitHub Application Client Secret',
              repo: 'King-Key.github.io',  //'GitHub repo',      // The repository of store comments,
              owner: 'King-Key', //'GitHub repo owner',
              admin: ['King-Key'], //['GitHub repo owner and collaborators, only these guys can initialize github issues'],
              id: location.pathname,      // Ensure uniqueness and length less than 50
              distractionFreeMode: false  // Facebook-like distraction free mode
            })
            gitalk.render('gitalk-container')
            </script>

            <div class="prev-link">
                
    
        
        
        <a class="previous" href="https://king-key.github.io/Blog/2023/Q2/"><</a>
    

            </div>

            <div class="next-link">
                
    
        
        
        
        
            
            
            
        
            
            
            
        
            
            
            
        
            
            
            
        
    

            </div>

        </div>
        
        
            
            <script type="text/javascript" src="https://king-key.github.io/elasticlunr.min.js"></script>
            <script type="text/javascript" src="https://king-key.github.io/search_index.en.js"></script>
            
            <script type="text/javascript" src="https://king-key.github.io/book.js"></script>
        

    </body>

</html>
